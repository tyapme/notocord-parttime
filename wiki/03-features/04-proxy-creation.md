# 代理申請

## 概要

レビュワーおよび管理者は、スタッフに代わってシフト申請を作成できます。代理申請は即座に「承認済み（approved）」ステータスで作成されます。

## 用途

- スタッフが直接申請できない状況
- 口頭・電話等で受けた依頼の記録
- 急なシフト調整

## 代理申請画面

### アクセス

1. ナビゲーションの「代理」タブをタップ
2. `/shift/proxy` 画面が表示される

### 画面構成

```
┌─────────────────────────────┐
│ 代理申請                     │
├─────────────────────────────┤
│ 対象スタッフ                 │
│ ┌─────────────────────────┐ │
│ │ 選択してください ▼       │ │
│ └─────────────────────────┘ │
│                             │
│ ※ スタッフを選択すると      │
│   申請フォームが表示されます  │
└─────────────────────────────┘
```

## 代理申請の作成

### 手順

1. 対象スタッフを選択
2. 申請内容を入力（スタッフの request_type に応じたフォーム）
3. 「作成」をタップ

### Fix タイプの代理申請

スタッフの `request_type` が `fix` の場合：

```
┌─────────────────────────────┐
│ 代理申請                     │
├─────────────────────────────┤
│ 対象スタッフ                 │
│ ┌─────────────────────────┐ │
│ │ 田中太郎                 │ │
│ └─────────────────────────┘ │
│                             │
│ 日付                        │
│ ┌─────────────────────────┐ │
│ │ 2026年3月1日             │ │
│ └─────────────────────────┘ │
│                             │
│ 開始時刻     終了時刻        │
│ ┌──────┐    ┌──────┐       │
│ │ 09:00 │    │ 17:00 │       │
│ └──────┘    └──────┘       │
│                             │
│ メッセージ（任意）           │
│ ┌─────────────────────────┐ │
│ │                         │ │
│ └─────────────────────────┘ │
│                             │
│      ［ 作成 ］             │
└─────────────────────────────┘
```

#### 入力項目

| 項目 | 必須 | 説明 |
|------|:----:|------|
| 対象スタッフ | ✅ | 申請対象のスタッフ |
| 日付 | ✅ | シフトの日付 |
| 開始時刻 | ✅ | HH:MM 形式 |
| 終了時刻 | ✅ | HH:MM 形式 |
| メッセージ | - | 任意のコメント |

### Flex タイプの代理申請

スタッフの `request_type` が `flex` の場合：

```
┌─────────────────────────────┐
│ 代理申請                     │
├─────────────────────────────┤
│ 対象スタッフ                 │
│ ┌─────────────────────────┐ │
│ │ 佐藤花子                 │ │
│ └─────────────────────────┘ │
│                             │
│ 対象週                      │
│ ┌─────────────────────────┐ │
│ │ 2026年 第10週            │ │
│ │ (3/2〜3/8)               │ │
│ └─────────────────────────┘ │
│                             │
│ 希望時間数                   │
│ ┌─────────────────────────┐ │
│ │ 20 時間                  │ │
│ └─────────────────────────┘ │
│                             │
│ メッセージ（任意）           │
│ ┌─────────────────────────┐ │
│ │                         │ │
│ └─────────────────────────┘ │
│                             │
│      ［ 作成 ］             │
└─────────────────────────────┘
```

#### 入力項目

| 項目 | 必須 | 説明 |
|------|:----:|------|
| 対象スタッフ | ✅ | 申請対象のスタッフ |
| 対象週 | ✅ | シフトの対象週 |
| 希望時間数 | ✅ | 1〜40の整数 |
| メッセージ | - | 任意のコメント |

## バリデーション

代理申請も通常の申請と同じバリデーションが適用されます。

### Fix の制限
- 終了時刻 > 開始時刻
- 勤務時間 ≤ 8時間
- 過去日は不可
- 3ヶ月先超は不可
- 既存申請との重複不可

### Flex の制限
- 1 ≤ 希望時間数 ≤ 40
- 過去週は不可
- 3ヶ月先超は不可
- 同一週の重複申請不可

## 代理申請の特徴

### 即時承認

代理申請は作成時に自動的に承認されます：

```typescript
// 作成時のステータス
status: 'approved'
decision_type: 'approve'
```

### 履歴への記録

代理申請は履歴に `proxy_create` アクションとして記録されます：

```
変更履歴
├─ 2026/02/25 10:00
│  代理作成 by 管理者A
│  → 確定（承認）
```

### 作成者の記録

- `created_by`: 代理作成した人のユーザーID
- `user_id`: 申請対象のスタッフのユーザーID

## 代理申請後の操作

### レビュワー/管理者

- 編集して再確定可能
- 取り消し可能

### 対象スタッフ

- 確認のみ可能
- 編集・取り下げは不可（承認済みのため）

## RPC 関数

### Fix 代理申請

```sql
proxy_create_fix_request(
  user_id uuid,      -- 対象スタッフのID
  start_at timestamp,
  end_at timestamp,
  note text
)
```

### Flex 代理申請

```sql
proxy_create_flex_request(
  user_id uuid,        -- 対象スタッフのID
  date_in_week date,   -- 対象週の任意の日
  requested_hours integer,
  note text
)
```

## ベストプラクティス

### 1. 記録の正確性
- 口頭で受けた内容を正確に入力
- メッセージに経緯を記載

### 2. 重複確認
- 代理申請前に既存申請を確認
- 重複エラーを避ける

### 3. 事後連絡
- 代理申請後にスタッフに連絡
- 内容の確認を依頼

## 注意事項

### スタッフ選択
- 有効（active=true）なスタッフのみ選択可能
- 無効化されたスタッフは表示されない

### request_type の確認
- スタッフの request_type に応じたフォームが自動的に表示
- Fix スタッフに Flex 申請はできない（その逆も同様）

## 関連ドキュメント

- [シフト承認](02-reviewer-approval.md)
- [シフト申請（スタッフ向け）](01-staff-requests.md)
- [RPC 関数](../05-api/03-rpc-functions.md)
